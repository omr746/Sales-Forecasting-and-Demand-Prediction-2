import streamlit as st
import requests
import pandas as pd
import base64
from io import BytesIO
from PIL import Image

# -------------------------------
# CONFIG
# -------------------------------
API_URL = "https://proadministration-genevive-nonilluminatingly.ngrok-free.dev/generate"
API_KEY = "12345"  # Same API_KEY as FastAPI

st.title("ðŸ“Š Future Sales Forecast Dashboard")

st.markdown("""
This dashboard fetches future sales predictions from the FastAPI backend
and displays the forecast plot generated by the backend.
""")

if st.button("Generate Forecast"):

    with st.spinner("Fetching predictions..."):

        headers = {"Authorization": f"Bearer {API_KEY}"}
        payload = {}  # backend uses your real forecast logic

        try:
            response = requests.post(API_URL, json=payload, headers=headers)
            if response.status_code != 200:
                st.error(f"Error from server: {response.text}")
            else:
                data = response.json()
                
                # Show table
                dates = pd.to_datetime(data["dates"])
                preds = data["predictions"]
                df = pd.DataFrame({"Date": dates, "Predicted Sales": preds})

                st.subheader("ðŸ“ˆ Forecast Table")
                st.dataframe(df)

                # Display the plot from backend
                plot_base64 = data["plot_base64"]
                plot_bytes = base64.b64decode(plot_base64)
                image = Image.open(BytesIO(plot_bytes))

                st.subheader("ðŸ“Š Forecast Plot")
                st.image(image, use_column_width=True)

        except Exception as e:
            st.error(f"Error: {e}")
